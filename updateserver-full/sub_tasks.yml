- name: sub-tasks-->检查server{{ server_id }}进程
  shell: "pgrep -f '/data/server{{ server_id }}/game/p8_app_server'"
  register: game_stat
  ignore_errors: yes

- name: sub-tasks-->停止server{{ server_id }}
  shell: "./server.sh flush && sleep 10 && ./server.sh stop"
  args:
    chdir: "/data/server{{ server_id }}/game"
  when: game_stat.rc == 0

- name: sub-tasks-->复制更新包到server{{ server_id }}
  copy:
    src: /data/update/full/
    dest: "/data/server{{ server_id }}/game/"
    remote_src: yes

- name: sub-tasks-->删除server{{ server_id }}下的nohup.txt
  file:
    path: "/data/server{{ server_id }}/game/nohup.txt"
    state: absent

- name: sub-tasks-->启动server{{ server_id }}
  shell: "./server.sh start && sleep 3"
  args:
    chdir: "/data/server{{ server_id }}/game"

- name: sub-tasks-->验证server{{ server_id }}状态
  shell: "pgrep -f '/data/server{{ server_id }}/game/p8_app_server'"
  register: game_stat_new
  ignore_errors: yes

- name: sub-tasks-->如果启动失败则退出剧本
  fail:
    msg: "server{{ server_id }}启动失败"
  when: game_stat_new.rc != 0