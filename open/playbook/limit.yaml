- hosts: "{{host_name}}"
  tasks:
    - name: 0-1 检查文件夹是否存在
      stat:
        path: /data/server
      register: folder_status
    
    - name: 0-2 当文件夹不存在时退出剧本
      fail:
        msg: "目录 /data/server 不存在，终止剧本执行。"
      when: not folder_status.stat.exists
    
    - name: 1-1 svc编号放入到limit文件中
      lineinfile:
        path: /data/server/login/etc/limit_create.txt
        line: "{{ svc_num }}"
        create: yes
    
    - name: 1-2 使用临时文件存放, 排序并去重 limit_create.txt
      shell: "sort -n /data/server/login/etc/limit_create.txt | uniq > /data/server/login/etc/limit_create_sorted.txt"
    
    - name: 1-3 替换文件为去重后的内容
      command: mv /data/server/login/etc/limit_create_sorted.txt /data/server/login/etc/limit_create.txt
    
    - name: 1-4 赋予执行权限
      file:
        path: /data/server/login/server.sh
        mode: 'u+x'

    - name: 1-5 检查进程是否存活
      shell: pgrep -f /data/server/login/p8_app_server
      register: login_stat
      ignore_errors: yes

    - name: 1-6 如果不存活则尝试启动
      shell: "./server.sh start && sleep 3"
      args:
        chdir: /data/server/login/
      when: login_stat.rc != 0
    
    - name: 1-7 执行/data/server/login/server.sh reload
      shell: "./server.sh reload && sleep 3"
      args:
        chdir: /data/server/login/
      when: login_stat.rc == 0
    
    - name: 1-8 最终检查进程状态
      shell: pgrep -f /data/server/login/p8_app_server
      register: final_stat
      ignore_errors: yes
      when: login_stat.rc != 0
    
    - name: 1-9 确认启动是否成功
      fail:
        msg: "尝试启动/data/server/login/p8_app_server 失败"
      when: 
        - login_stat.rc != 0
        - final_stat.rc != 0
