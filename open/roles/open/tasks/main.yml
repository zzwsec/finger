---
- name: 1-0检查/data/serverX/目录是否存在
  stat:
    path: /data/server{{ svc_num }}
  register: dir_check

- name: 1-1目录不存在，终止剧本执行
  fail:
    msg: "目录/data/server{{ svc_num }}不存在，停止剧本执行"
  when: not dir_check.stat.exists

- name: 1-2分发时间文件
  copy:
    src: open_time.lua
    dest: /data/server{{ svc_num }}/game/lua/config/open_time.lua

- name: 1-3 初始检测进程状态
  shell: "pgrep -f /data/server{{ svc_num }}/game/p8_app_server"
  register: svc_stat
  ignore_errors: yes

- name: 1-4进程存活时执行Reload
  shell: "cd /data/server{{ svc_num }}/game/ && ./server.sh reload && sleep 3"
  when: svc_stat.rc == 0

- name: 1-5进程不存在，尝试启动服务
  shell: "cd /data/server{{ svc_num }}/game/ && ./server.sh start && sleep 3"
  when: svc_stat.rc != 0
  ignore_errors: yes

- name: 1-6最终检测进程状态
  shell: "pgrep -f /data/server{{ svc_num }}/game/p8_app_server"
  register: start_attempt
  ignore_errors: yes

- name: 1-7检查启动是否成功
  fail:
    msg: "服务启动失败，已尝试启动但仍无进程"
  when: start_attempt.rc != 0
  
- name: 2-1执行server-login.sh
  shell: "cd /data/server/login/ && ./server.sh reload && sleep 3"
